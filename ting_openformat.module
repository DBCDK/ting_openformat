<?php
// @TODO; implement entity
// hook_entity_infon etc..

// load search info and hooks
module_load_include('inc', 'ting_openformat','ting_openformat.search');
module_load_include('inc', 'ting_openformat' ,'ting_openformat.field');


function ting_openformat_menu(){
  $items = array();
   $items['work/%'] = array(
    'title' => 'Single work',
    'description' => 'View single work',
    'page arguments' => array(1),
    'page callback' => 'ting_openformat_single',
    'access arguments' => array('access content'),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

function ting_openformat_single($id){
  return t("return work with id $id");
}


/**
 * Implements hook_form_FORMID_alter (ting_client_admin_webservices_settings @see ting_client.admin.inc).
 * make openformat a dropdownlist.
 * add bibliotekdkWorkDisplay to ting_admin form
 */
function ting_openformat_form_ting_client_admin_webservices_settings_alter (&$form, &$form_state) {
  if( isset ( $form['webservices']['ting_search_openformat']  ) ) {
    $dkabm = $form['webservices']['ting_search_openformat']['#default_value'];
    $element = &$form['webservices']['ting_search_openformat'];
    // change type to select
    $element['#type'] = 'select';
    // set the original option (dkabm)
    $element['#options']['dkabm'] = 'dkabm';
    // add bibliotekdkWorkDisplay to options
    $element['#options']['bibliotekdkWorkDisplay'] = 'bibliotekdkWorkDisplay';
    // set default value
    //$form['webservices']['ting_search_openformat']['#default_value'] = 'bibliotekdkWorkDisplay';
  }
}

/**
 * Implements hook_menu
 **/
function ting_openformat_hook_menu() {
  //dpm('TESTHEST');
  $items['admin/config/ting_openformat'] = array(
    'title' => 'Openformat',
    'description' => 'Handle ting_openformat module (disable)',
    'position' => 'left',
    'weight' => 1,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  $items['admin/config/ting_openformat/disable'] = array(
    'title' => 'Disable this module',
    'description' => 'Delete virtual fields from this module and disable it',
    'weight' => 1,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ting_openformat_admin_module_disable'),
    'access arguments' => array('administer webservices settings'),
    'file' => 'ting_openformat.admin.inc'
  );

  return $items;
}

/************** ENTITY ****************/

/** @TODO make this work
 * Implements hook_entity_info
 * define a new entity
 **/

function ting_openformat_entity_info() {
  $return = array(
    'bibdkManifestation' => array(
      'label' => t('openformat manifestation'),
      'fieldable' => TRUE,
      'base table' => 'ting_openformat_manifestation',

      // make this a ding_entity ?
      'ding_entity_type' => 'bibdk_manifestation',
      //'ding_entity_type' => 'ting_openformat_manifestation',
      'ding_entity_menu' => '/manifestation/%ting_manifestation',
      'ding_entity_index' => 2,
      // 'ding_entity_bundle' => 'bibdk_entity',

      // uri callback
      //'uri callback' => 'ting_openformat_maniobject_uri',

      /* for clarity. default implementation of load hook */
      // 'load hook' => 'manifestation_load',
      'description' => t('openformat fields'),
      // leave controller class blank for now (use DrupalDefaultEntityController) @TODO implement
      'controller class' => 'ManifestionEntityAPIController',
      'entity keys' => array(
        //'id' => 'tid',
        //'ding_entity_id' => 'ding_entity_id',
        'id' => 'ding_entity_id',
      ),
      'bundles' => array(
        'bibdkManifestation' => array(
          'label' => 'openformat manifestation',
          'admin' => array(
            'path' => 'admin/structure/manifestations',
            'access arguments' => array('administer content types'),
          ),
        ),
      ),
    ),


      'bibdkWorkEntity' => array(
        'label' => t('Bibdk entity placeholder for manifestations'),
        'fieldable' => TRUE,
        // ?? do we need the base table -- it is not used for anything since controllerclass
        // only implements DrupalEntityControllerInterface and not DrupalDefaultEntityController
        'base table' => 'ting_openformat_manifestation',
        // make this a ding_entity ?
        'ding_entity_type' => 'bibdk_entity',
        //'ding_entity_type' => 'ting_openformat_manifestation',
        'ding_entity_menu' => '/manifestation/%ting_manifestation',
        'ding_entity_index' => 2,
        //... could an additional argument be used in ding_entity ?? maybe for setting bundels
        // 'ding_entity_bundle' => 'bibdk_entity',
        'controller class' => 'bibdkEntityAPIController',
        'load hook' => 'manifestations_load',
        'entity keys' => array(
          //'id' => 'tid',
          //'ding_entity_id' => 'ding_entity_id',
          'id' => 'ding_entity_id',
        ),
        'bundles' => array(
          'bibdkWorkEntity' => array(
            'label' => 'bibdkWorkEntity',
            'admin' => array(
              'path' => 'admin/structure/bibdkWork',
              'access arguments' => array('administer content types'),
            ),
          ),
        ),
      )


  );

  return $return;
}

/**
 * Load hook as set in entity_info
 * load hook is not currently used .. maybe later.
 */
function ting_openformat_manifestations_load($stdObjects) {
  $ret = array();
  return $ret;
}

/**
 * uri callback as defined in hook_entity_info
 **/
function ting_openformat_maniobject_uri() {
  return 'HEST';
}

/**************** end ENTITY ***************/

/***********  panel-pages ****************/

/**
 * Implements hook_ctools_plugin_directory().
 *
 * It simply tells panels where to find the .inc files that define various
 * args, contexts, content_types.
 */
function ting_openformat_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implement hook_ctools_plugin_api().
 */
function ting_openformat_ctools_plugin_api($module, $api) {
  if ($module == 'page_manager' && $api == 'pages_default') {
    return array('version' => 1);
  }
}

/**************** end panel-pages ***************/

/** Implements hook_ding_devel_timers
 */
function ting_openformat_ding_devel_timers() {
  return array(
    'search_client' => array(
      'title' => 'Search client total request time was @time ms.',
    ),
    'search_client_net' => array(
      'title' => 'Search client net time was @time ms.',

      'include in total' => FALSE,
    ));
}


/************* VIEWS **************/

/*
 * preprocess template to add stylesheet
 * @TODO; this method is for developing only - move and adjust css to proper file when ready
 */
function template_preprocess_ting_openformat_subwork_tabs(&$variables){
  $path = drupal_get_path('module', 'ting_openformat') . '/css';
  drupal_add_css($path.'/ting_openformat_subwork.css');
  //  dpm($variables);
}


/** \brief load a single work
 * @params id; id of work to load
 * return bibdkWork entity
 **/
function ting_openformat_view_work_by_id($id) {
  // @TODO ; implement a'la :
  // $work=entity_load('bibdkWorkentity', $id , ....)
  // return ting_openformat_work_view( $work, ... );
}

// @TODO - does this method belong here ??

function ting_openformat_work_view($bibdkWork, $view_mode = 'full', $langcode = NULL) {
  if (!isset($langcode)) {
    $langcode = $GLOBALS['language_content']->language; }

  $args = array();
  $work_fields = array();
  $work_fields += _prepare_view('bibdkWorkEntity', $bibdkWork, $view_mode, $langcode);

  $subWorks =  _ting_openformat_parse_subworks($bibdkWork->getManifestations());
  // dpm($subWorks);
  $sub = array();
  foreach( $subWorks as $type => $manifestations ) {
    //$sub['type'] = $type;
    $field_content = array();
    foreach( $manifestations as $id=>$manifestation ) {
      $sub_tab[$type][] = $id;
      $field_content = _prepare_view('bibdkManifestation', $manifestation, $view_mode, $langcode);
      $sub[$type][$manifestation->id] = theme('ting_openformat_manifestation',array('fields'=>$field_content,));
    }
  }
  $tabs = theme('ting_openformat_subwork_tabs',array('subWorks'=>$subWorks));
  //dpm($tabs);
  return theme('ting_openformat_work',array('fields'=>$work_fields,'subWorks'=>$sub,'tabs'=>$tabs,'ding_id' => $bibdkWork->id));
}

function _ting_openformat_parse_subworks($manifestations) {
  $subWorks = array();
  foreach( $manifestations as $id => $manifestation ) {
    $subWorks[$manifestation->getType()][$id] = $manifestation;
  }
  return $subWorks;
}

/**
 * attach entity fields to a single entity. Return a renderable array
 **/
function _prepare_view($entity_type, $object, $view_mode, $langcode) {
  field_attach_prepare_view($entity_type, array($object->id => $object), $view_mode, $langcode);
  entity_prepare_view($entity_type, array($object->id => $object), $langcode);
  $content = field_attach_view($entity_type, $object, $view_mode, $langcode);

  return $content;
}



/*********** END VIEWS ***********/


/******************* ADMIN *****************/

/**
 * Impelments hook_flush_caches
 **/

function ting_openformat_flush_caches() {
  return array('cache_bibdk_webservices');
}

/*** FACETBROWSER ****/

/**
 * Implements hook_ding_facetbrowser().
 * initialize facetbrowser
 */
function ting_openformat_ding_facetbrowser() {
  $results             = new stdClass();
  $results->show_empty = FALSE;
  $search_result       = drupal_static('ting_search_results');
  if ($search_result) {
    $results->facets     = ($search_result instanceof TingClientSearchResult) ? $search_result->facets : array();
    $results->searchkey  = $search_result->search_key;
    return $results;
  }
}


/**
 * Implements hook_menu_alter().
 *
 * add menu item on admin/structure .. maybe this can be done via EntityDefaultUIController -- @see entity module
 *
 * Adjusts the menu so that the field subtab becomes the default local task,
 * to avoid having an useless placeholder page.
 */
function ting_openformat_menu_alter(&$items) {
  if (module_exists('field_ui')) {
    if (isset($items['admin/structure/bibdkWork/fields'])) {
      // Make the fields task the default local task.
      $items['admin/structure/bibdkWork'] = $items['admin/structure/bibdkWork/fields'];
      //$items['admin/structure/bibdkWork'] = $items['admin/structure/bibdkWork'];
      $item = &$items['admin/structure/bibdkWork'];
      $item['type'] = MENU_NORMAL_ITEM;
      $item['title'] = 'Work entity for bibliotek.dk';
      $item['description'] = 'Manage work display.';

      $items['admin/structure/bibdkWork/fields'] = array(
        'title' => 'Manage fields',
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'weight' => 1,
      );
    }
    if (isset($items['admin/structure/manifestations/fields'])) {
      // Make the fields task the default local task.
      $items['admin/structure/manifestations'] = $items['admin/structure/manifestations/fields'];
      //$items['admin/structure/bibdkWork'] = $items['admin/structure/bibdkWork'];
      $item = &$items['admin/structure/manifestations'];
      $item['type'] = MENU_NORMAL_ITEM;
      $item['title'] = 'manifestations for bibliotek.dk';
      $item['description'] = 'Manage work display.';

      $items['admin/structure/manifestations/fields'] = array(
        'title' => 'Manage fields',
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'weight' => 1,
      );
    }
  }
}



